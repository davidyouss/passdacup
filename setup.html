// 1. ATTACH TO WINDOW TO ENSURE ACCESSIBILITY
window.S_URL = 'https://yhywgwohyzrcbzgxxtyb.supabase.co';
window.S_KEY = 'sb_publishable_zYteMuxmxLbR0mxUDe8a3w_8brmZ2sv';
window.sb = supabase.createClient(window.S_URL, window.S_KEY);

window.roster = []; 
window.r_id = ""; 
window.selectedGamePk = null; 
window.lastIdx = -1; 
window.gameName = ""; 
window.unit = 5;
window.pollInterval = null;

console.log("MANAGER SYSTEM BOOTED");

// 2. ADD PLAYER
window.addPlayer = function() {
    const el = document.getElementById('p-input');
    if (!el || !el.value) return;
    const val = el.value.trim().toUpperCase();
    window.roster.push({ name: val, balance: 0 });
    el.value = "";
    window.draw();
};

// 3. DRAW LINEUP
window.draw = function() {
    const listEl = document.getElementById('p-list');
    if (!listEl) return;
    listEl.innerHTML = window.roster.map((p, i) => `
        <div class="flex justify-between p-2 mb-1 bg-gray-800 rounded border border-gray-700">
            <span>${p.name}</span>
            <button onclick="window.roster.splice(${i},1);window.draw()" class="text-red-500 font-bold px-2">X</button>
        </div>
    `).join('');
};

// 4. FETCH GAMES (JULY 10, 2025)
window.findGames = async function(e) {
    try {
        const resp = await fetch('https://statsapi.mlb.com/api/v1/schedule/games/?sportId=1&date=2025-07-10');
        const data = await resp.json();
        const select = document.getElementById('game-select');
        if (!select) return;
        
        select.innerHTML = '<option value="">-- SELECT GAME --</option>';
        data.dates[0].games.forEach(g => {
            let opt = document.createElement('option');
            opt.value = g.gamePk;
            opt.text = g.teams.away.team.name.toUpperCase() + " @ " + g.teams.home.team.name.toUpperCase();
            select.appendChild(opt);
        });
        select.classList.remove('hidden');
        if (e && e.target) e.target.classList.add('hidden');
        console.log("Games loaded successfully");
    } catch (err) { console.error("API Error:", err); }
};

// 5. START GAME
window.startGame = async function() {
    if (window.roster.length < 2) return alert("ADD 2+ PLAYERS!");
    const sel = document.getElementById('game-select');
    if (!sel || !sel.value) return alert("SELECT A GAME!");

    window.gameName = sel.options[sel.selectedIndex].text;
    window.unit = parseFloat(document.getElementById('base-bet').value) || 5; 
    window.r_id = Math.random().toString(36).substring(2, 6).toUpperCase();
    
    window.roster.forEach(p => p.balance = -window.unit);
    
    document.getElementById('setup-area').classList.add('hidden');
    document.getElementById('remote').classList.remove('hidden');
    document.getElementById('game-title-display').innerText = window.gameName;
    
    window.updateManagerUI(window.roster, 0);

    const { error } = await window.sb.from('games').insert([{ 
        id: window.r_id, 
        players: window.roster, 
        pot_total: (window.unit * window.roster.length), 
        current_holder_index: 0, 
        last_event: "PLAY BALL!", 
        game_name: window.gameName 
    }]);

    if (error) return alert("Supabase Error: " + error.message);
    window.selectedGamePk = sel.value;
    window.pollInterval = setInterval(window.checkMLB, 10000); 
};

// 6. REPLAY ENGINE
window.checkMLB = async function() {
    try {
        const resp = await fetch(`https://statsapi.mlb.com/api/v1/game/${window.selectedGamePk}/playByPlay`);
        const data = await resp.json();
        const nextIdx = window.lastIdx + 1;
        
        if (data.allPlays && data.allPlays[nextIdx]) {
            const play = data.allPlays[nextIdx];
            const event = (play.result.event || "").toLowerCase();
            const desc = play.result.description || "In progress...";
            
            document.getElementById('pbp-text').innerText = desc;
            await window.processMove(event, desc);
            window.lastIdx = nextIdx;
        }
    } catch (e) { console.log("Feed check..."); }
};

// 7. PROCESS MOVE
window.processMove = async function(type, desc) {
    const { data } = await window.sb.from('games').select('*').eq('id', window.r_id);
    if (!data || !data[0]) return;
    
    const g = data[0];
    let pot = parseFloat(g.pot_total), list = g.players, i = g.current_holder_index;

    if (type.includes('strikeout')) { 
        pot += (window.unit * 2); 
        list[i].balance -= (window.unit * 2); 
    } else if (type.includes('out')) { 
        pot += window.unit; 
        list[i].balance -= window.unit; 
    } else if (type.includes('single')) { 
        let win = Math.min(pot, window.unit); 
        pot -= win; 
        list[i].balance += win; 
    } else if (type.includes('home_run')) { 
        list[i].balance += pot; 
        pot = 0; 
    }

    let next_i = (i + 1) % list.length;
    window.updateManagerUI(list, next_i);
    
    await window.sb.from('games').update({ 
        pot_total: pot, 
        players: list, 
        current_holder_index: next_i, 
        last_event: desc 
    }).eq('id', window.r_id);
};

// 8. UI REFRESH
window.updateManagerUI = function(list, activeIdx) {
    const upNowEl = document.getElementById('up-now');
    if (upNowEl) upNowEl.innerText = list[activeIdx].name;
    const ledger = document.getElementById('ledger-list');
    if (!ledger) return;
    ledger.innerHTML = list.map((p, i) => `
        <div class="flex justify-between p-1 ${i === activeIdx ? 'text-blue-400 font-bold' : 'text-gray-400'}">
            <span>${p.name}</span>
            <span>$${p.balance.toFixed(2)}</span>
        </div>
    `).join('');
};
