<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager | Pass Da Cup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-black text-white p-6 font-sans">
    <div class="max-w-md mx-auto space-y-6 pb-20">
        <h1 class="text-3xl font-black italic text-yellow-500 uppercase tracking-tighter text-center">Manager Pro</h1>

        <div id="setup-area" class="space-y-4">
            <div class="space-y-2">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest text-center">1. Select Game (2025 Test Mode)</p>
                <button onclick="findGames(event)" class="w-full bg-gray-800 p-3 rounded-lg text-[10px] font-bold uppercase border border-gray-700">Find 2025 Games</button>
                <select id="game-select" class="w-full bg-gray-900 border border-gray-800 p-3 rounded-lg text-sm hidden font-bold text-yellow-500"></select>
            </div>

            <div class="space-y-2">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest text-center">2. Build Your Lineup</p>
                <div class="flex gap-2">
                    <input id="p-input" type="text" placeholder="Enter Name..." class="flex-grow bg-gray-900 border border-gray-800 p-3 rounded-lg outline-none font-bold text-white uppercase">
                    <button onclick="addPlayer()" class="bg-blue-600 px-6 rounded-lg font-black text-xl">+</button>
                </div>
                <div id="p-list" class="space-y-2 mt-2"></div>
                <button onclick="quickFill()" class="w-full bg-blue-600/10 text-blue-400 py-3 rounded-lg font-black uppercase text-[10px] border border-blue-400/20 tracking-widest mt-2">‚ö° Quick Fill 5 Players</button>
            </div>

            <button onclick="startGame()" class="w-full bg-yellow-500 text-black font-black py-4 rounded-xl uppercase shadow-lg shadow-yellow-500/20">Start Live Session</button>
        </div>

        <div id="remote" class="hidden space-y-4 pt-4">
            <div class="bg-blue-600 p-5 rounded-3xl text-center shadow-lg border-b-8 border-blue-800">
                <p class="text-[10px] font-black uppercase text-blue-100 mb-1 tracking-widest">Cup is with:</p>
                <h2 id="up-now" class="text-5xl font-black uppercase italic tracking-tighter">---</h2>
            </div>

            <div id="manager-ledger" class="grid grid-cols-1 gap-2 bg-gray-900 p-4 rounded-2xl border border-gray-800">
                <p class="text-[10px] font-black text-gray-600 uppercase tracking-[0.2em] mb-2 text-center">Live Standings</p>
                <div id="ledger-list" class="space-y-2"></div>
            </div>

            <div class="bg-gray-900 p-4 rounded-2xl border border-gray-800 text-center">
                <p id="pbp-text" class="text-[11px] italic text-yellow-500 font-bold leading-tight">Syncing MLB Feed...</p>
            </div>

            <div id="settlement-area" class="mt-4 border-t-2 border-red-900 pt-8 hidden">
                <h3 class="text-center text-red-500 font-black uppercase text-sm mb-6 italic tracking-widest">Final Settlement</h3>
                <div id="settlement-list" class="space-y-4"></div>
            </div>

            <div id="manager-controls" class="space-y-2 pt-6">
                <button id="end-btn" onclick="runSettlement()" class="w-full bg-red-600 text-white font-black py-5 rounded-2xl text-sm uppercase shadow-lg shadow-red-600/20">üèÅ End Game & Settle Up</button>
                <button onclick="copyShareLink(this)" class="w-full bg-white text-black font-black py-3 rounded-xl text-[10px] uppercase">üîó Share Scoreboard</button>
            </div>
        </div>
    </div>

    <script>
        const S_URL = 'https://yhywgwohyzrcbzgxxtyb.supabase.co';
        const S_KEY = 'sb_publishable_zYteMuxmxLbR0mxUDe8a3w_8brmZ2sv';
        const sb = supabase.createClient(S_URL, S_KEY);
        let roster = [], r_id = "", selectedGamePk = null, lastIdx = -1;

        function addPlayer() {
            const el = document.getElementById('p-input');
            if (el.value.trim()) { roster.push({ name: el.value.trim().toUpperCase(), balance: 0, unit: 5 }); el.value = ""; drawLineup(); }
        }

        function quickFill() {
            const names = ["ALICE", "BOB", "CHARLIE", "DAVE", "EVE"];
            roster = names.map(n => ({ name: n, balance: 0, unit: 5 }));
            drawLineup();
        }

        function drawLineup() {
            document.getElementById('p-list').innerHTML = roster.map((p, i) => `
                <div class="bg-gray-900 p-3 rounded-lg flex justify-between items-center border border-gray-800 font-bold text-xs uppercase">
                    <span>${p.name}</span>
                    <button onclick="roster.splice(${i},1);drawLineup()" class="text-red-500 px-2 text-lg">√ó</button>
                </div>
            `).join('');
        }

        async function findGames(e) {
            const resp = await fetch(`https://statsapi.mlb.com/api/v1/schedule/games/?sportId=1&date=2025-07-10`);
            const data = await resp.json();
            const select = document.getElementById('game-select');
            select.innerHTML = '<option value="">-- Select Game --</option>';
            data.dates[0].games.forEach(g => { let opt = document.createElement('option'); opt.value = g.gamePk; opt.text = `${g.teams.away.team.name} @ ${g.teams.home.team.name}`; select.appendChild(opt); });
            select.classList.remove('hidden'); e.target.classList.add('hidden');
        }

        async function startGame() {
            if (roster.length < 2) return alert("Add players!");
            r_id = Math.random().toString(36).substring(2, 6).toUpperCase();
            roster.forEach(p => { p.balance = -5; });
            await sb.from('games').insert([{ id: r_id, players: roster, pot_total: (5 * roster.length), current_holder_index: 0, last_event: "Waiting for first play..." }]);
            selectedGamePk = document.getElementById('game-select').value;
            document.getElementById('setup-area').classList.add('hidden');
            document.getElementById('remote').classList.remove('hidden');
            document.getElementById('room-display').innerText = `CODE: ${r_id}`;
            updateManagerUI(roster, 0);
            if(selectedGamePk) setInterval(checkMLB, 15000);
        }

        async function checkMLB() {
            try {
                const resp = await fetch(`https://statsapi.mlb.com/api/v1/game/${selectedGamePk}/playByPlay`);
                const data = await resp.json();
                if (!data.allPlays) return;
                
                // If it's the first check, skip to the latest play
                if (lastIdx === -1) { lastIdx = data.allPlays.length - 1; return; }

                const nextIdx = lastIdx + 1;
                if (data.allPlays[nextIdx]) {
                    const desc = data.allPlays[nextIdx].result.description;
                    document.getElementById('pbp-text').innerText = desc;
                    processMove(data.allPlays[nextIdx].result.event.toLowerCase(), desc);
                    lastIdx = nextIdx;
                }
            } catch(e) { console.log("Feed delay..."); }
        }

        async function processMove(type, desc) {
            let { data: g } = await sb.from('games').select('*').eq('id', r_id).single();
            let pot = parseFloat(g.pot_total), list = g.players, i = g.current_holder_index;
            if (type.includes('strikeout')){ pot += 10; list[i].balance -= 10; }
            else if (type.includes('out')){ pot += 5; list[i].balance -= 5; }
            else if (type.includes('single')){ let a=Math.min(pot,5); pot-=a; list[i].balance+=a; }
            else if (type.includes('hr')){ list[i].balance+=pot; pot=0; }
            let next_i = (i + 1) % list.length;
            updateManagerUI(list, next_i);
            await sb.from('games').update({ pot_total: pot, players: list, current_holder_index: next_i, last_event: desc }).eq('id', r_id);
        }

        function updateManagerUI(list, activeIdx) {
            document.getElementById('up-now').innerText = list[activeIdx].name;
            document.getElementById('ledger-list').innerHTML = list.map((p, i) => `
                <div class="flex justify-between items-center text-[10px] font-bold ${i === activeIdx ? 'text-blue-400' : 'text-gray-400'}">
                    <span>${i === activeIdx ? 'üç∫ ' : ''}${p.name}</span>
                    <span class="${p.balance < 0 ? 'text-red-500' : 'text-green-500'}">${p.balance < 0 ? '-' : ''}$${Math.abs(p.balance).toFixed(2)}</span>
                </div>
            `).join('');
        }

        async function runSettlement() {
            let { data: g } = await sb.from('games').select('*').eq('id', r_id).single();
            let givers = g.players.filter(p => p.balance < 0).map(p => ({ n: p.name, a: Math.abs(p.balance) }));
            let takers = g.players.filter(p => p.balance > 0).map(p => ({ n: p.name, a: p.balance }));
            let txs = [], gi=0, ti=0;
            while(gi < givers.length && ti < takers.length) {
                let pay = Math.min(givers[gi].a, takers[ti].a);
                if(pay > 0.01) txs.push({ f: givers[gi].n, t: takers[ti].n, a: pay.toFixed(2) });
                givers[gi].a -= pay; takers[ti].a -= pay;
                if(givers[gi].a < 0.01) gi++; if(takers[ti].a < 0.01) ti++;
            }
            document.getElementById('settlement-list').innerHTML = txs.map(t => `
                <div class="bg-gray-800 p-5 rounded-3xl flex flex-col items-center space-y-2">
                    <div class="flex justify-between w-full font-black uppercase italic italic text-sm">
                        <span class="text-red-500">${t.f}</span>
                        <span class="text-white text-2xl">$${t.a}</span>
                        <span class="text-green-500">${t.t}</span>
                    </div>
                    <div class="text-[9px] font-black text-gray-500 tracking-[0.3em]">PAYS</div>
                </div>`).join('');
            document.getElementById('settlement-area').classList.remove('hidden');
            document.getElementById('manager-controls').classList.add('hidden');
        }

        function copyShareLink(btn) {
            navigator.clipboard.writeText(window.location.origin + "/index.html?id=" + r_id).then(() => { btn.innerText = "COPIED!"; setTimeout(() => btn.innerText = "üîó Share Scoreboard", 2000); });
        }
    </script>
</body>
</html>
