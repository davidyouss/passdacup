<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pass Da Cup - Manager Setup</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Ensure no horizontal scroll */
        body {
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
        
        /* Make tap targets bigger on mobile */
        button, input, select {
            min-height: 44px;
        }
        
        /* Prevent zoom on input focus on iOS */
        input, select, textarea {
            font-size: 16px;
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen p-4 sm:p-8">
    
    <!-- SETUP AREA -->
    <div id="setup-area" class="max-w-2xl mx-auto">
        <div class="text-center mb-6">
            <h1 class="text-4xl sm:text-6xl font-black mb-2">üç∫ PASS DA CUP</h1>
            <p class="text-gray-500 uppercase tracking-widest text-xs">Manager Setup</p>
        </div>

        <!-- PLAYER ROSTER -->
        <div class="bg-gray-900 rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 border-2 border-gray-800">
            <h2 class="text-lg sm:text-xl font-black mb-3 sm:mb-4 uppercase">Add Players</h2>
            
            <!-- Input and button in single row that FITS on mobile -->
            <div class="flex gap-2 mb-4">
                <input 
                    type="text" 
                    id="p-input" 
                    placeholder="NAME"
                    class="flex-1 min-w-0 bg-black border-2 border-gray-700 rounded-xl px-3 sm:px-4 py-3 text-white uppercase font-bold focus:border-blue-500 focus:outline-none text-sm sm:text-base"
                    onkeypress="if(event.key==='Enter') window.addPlayer()"
                />
                <button 
                    onclick="window.addPlayer()"
                    class="bg-blue-600 hover:bg-blue-500 px-4 sm:px-6 py-3 rounded-xl font-black uppercase transition-colors whitespace-nowrap text-sm sm:text-base"
                >
                    ADD
                </button>
            </div>
            <div id="p-list"></div>
        </div>

        <!-- GAME SETTINGS -->
        <div class="bg-gray-900 rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 border-2 border-gray-800">
            <h2 class="text-lg sm:text-xl font-black mb-3 sm:mb-4 uppercase">Game Settings</h2>
            
            <div class="mb-4">
                <label class="block text-gray-500 text-xs uppercase mb-2">Base Bet (Per Unit)</label>
                <input 
                    type="number" 
                    id="base-bet" 
                    value="5"
                    min="1"
                    class="w-full bg-black border-2 border-gray-700 rounded-xl px-3 sm:px-4 py-3 text-white font-bold focus:border-blue-500 focus:outline-none"
                />
            </div>

            <!-- TEST MODE TOGGLE -->
            <div class="mb-4 p-3 sm:p-4 bg-gray-950 rounded-xl border border-gray-700">
                <label class="flex items-center cursor-pointer">
                    <input 
                        type="checkbox" 
                        id="test-mode" 
                        class="w-5 h-5 mr-3 flex-shrink-0"
                        onchange="window.updateDateDisplay()"
                    />
                    <div class="min-w-0">
                        <div class="font-bold text-sm uppercase text-yellow-400">üß™ Test Mode</div>
                        <div class="text-xs text-gray-500">Use July 10, 2025 for testing</div>
                    </div>
                </label>
            </div>

            <div id="date-display" class="mb-4 p-3 bg-gray-950 rounded-xl text-center">
                <div class="text-xs text-gray-500 uppercase mb-1">Fetching Games For</div>
                <div id="fetch-date" class="font-mono font-bold text-blue-400 text-sm"></div>
            </div>

            <button 
                onclick="window.findGames(event)"
                class="w-full bg-green-600 hover:bg-green-500 px-4 sm:px-6 py-3 sm:py-4 rounded-xl font-black uppercase transition-colors mb-4 text-sm sm:text-base"
            >
                üéÆ LOAD GAMES
            </button>

            <select 
                id="game-select" 
                class="hidden w-full bg-black border-2 border-gray-700 rounded-xl px-3 sm:px-4 py-3 text-white font-bold focus:border-blue-500 focus:outline-none mb-4 text-sm sm:text-base"
            >
                <option value="">-- SELECT GAME --</option>
            </select>

            <button 
                onclick="window.startGame()"
                class="w-full bg-red-600 hover:bg-red-500 px-4 sm:px-6 py-3 sm:py-4 rounded-xl font-black uppercase transition-colors text-sm sm:text-base"
            >
                üöÄ START GAME
            </button>
        </div>
    </div>

    <!-- REMOTE CONTROL AREA (HIDDEN AT START) -->
    <div id="remote" class="hidden max-w-2xl mx-auto">
        <div class="text-center mb-6">
            <h1 class="text-2xl sm:text-4xl font-black mb-2" id="game-title-display"></h1>
            <p class="text-gray-500 uppercase tracking-widest text-xs">Manager Remote</p>
            <p id="game-status-display" class="text-xs text-blue-400 mt-2"></p>
        </div>

        <!-- SHARE LINK -->
        <div class="bg-gray-900 rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 border-2 border-gray-800 text-center">
            <button 
                onclick="window.copyShareLink(this)"
                class="bg-blue-600 hover:bg-blue-500 px-6 sm:px-8 py-3 sm:py-4 rounded-xl font-black uppercase transition-colors text-sm sm:text-base w-full sm:w-auto"
            >
                üîó SCOREBOARD LINK
            </button>
            <p class="text-gray-600 text-xs mt-3">Share this with players to view live scores</p>
        </div>

        <!-- CURRENT AT BAT -->
        <div class="bg-gradient-to-r from-blue-900 to-blue-800 rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 border-2 border-blue-700 text-center">
            <p class="text-gray-400 text-xs uppercase mb-2">Currently At Bat</p>
            <p id="up-now" class="text-3xl sm:text-4xl font-black"></p>
        </div>

        <!-- POT DISPLAY -->
        <div class="bg-gradient-to-r from-green-900 to-green-800 rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 border-2 border-green-700 text-center">
            <p class="text-gray-400 text-xs uppercase mb-2">Current Pot</p>
            <p id="pot-display" class="text-3xl sm:text-4xl font-black font-mono">$0.00</p>
        </div>

        <!-- PLAY BY PLAY -->
        <div class="bg-gray-900 rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 border-2 border-gray-800">
            <div class="flex flex-col sm:flex-row justify-between sm:items-center mb-3 gap-2">
                <h2 class="text-sm font-black uppercase text-gray-500">Live Feed</h2>
                <span id="replay-status" class="text-xs text-gray-600"></span>
            </div>
            <p id="pbp-text" class="text-white italic text-sm">Waiting for first pitch...</p>
        </div>

        <!-- LEDGER -->
        <div class="bg-gray-900 rounded-2xl p-4 sm:p-6 mb-4 sm:mb-6 border-2 border-gray-800" id="manager-controls">
            <h2 class="text-lg sm:text-xl font-black mb-4 uppercase">Standings</h2>
            <div id="ledger-list"></div>
            <button 
                onclick="window.runSettlement()"
                class="w-full bg-green-600 hover:bg-green-500 px-4 sm:px-6 py-3 sm:py-4 rounded-xl font-black uppercase transition-colors mt-4 text-sm sm:text-base"
            >
                üí∞ SETTLE UP
            </button>
        </div>

        <!-- SETTLEMENT AREA -->
        <div id="settlement-area" class="hidden">
            <div class="bg-gray-900 rounded-2xl p-4 sm:p-6 border-2 border-gray-800">
                <h2 class="text-xl sm:text-2xl font-black mb-4 sm:mb-6 uppercase text-center">üí∏ Final Settlement</h2>
                <div id="settlement-list"></div>
            </div>
        </div>
    </div>

    <script>
        // 1. CONFIGURATION & SETUP
        window.S_URL = 'https://yhywgwohyzrcbzgxxtyb.supabase.co';
        window.S_KEY = 'sb_publishable_zYteMuxmxLbR0mxUDe8a3w_8brmZ2sv';
        window.sb = supabase.createClient(window.S_URL, window.S_KEY);
        window.roster = [];
        window.r_id = "";
        window.selectedGamePk = null;
        window.lastIdx = -1;
        window.gameName = "";
        window.unit = 5;
        window.pollInterval = null;
        window.currentPot = 0;
        
        // Date configuration
        const TEST_DATE = '2025-07-10';
        const SPRING_TRAINING_START = new Date('2025-02-20');
        
        console.log("MANAGER SYSTEM BOOTED");
        
        // Initialize date display
        window.updateDateDisplay = function() {
            const testMode = document.getElementById('test-mode').checked;
            const today = new Date().toISOString().split('T')[0];
            const fetchDate = testMode ? TEST_DATE : today;
            document.getElementById('fetch-date').innerText = fetchDate;
            
            // Clear game selection if date changes
            const select = document.getElementById('game-select');
            if (select) {
                select.classList.add('hidden');
                select.innerHTML = '<option value="">-- SELECT GAME --</option>';
            }
        };
        
        // Set initial date display on load
        window.addEventListener('DOMContentLoaded', () => {
            // Auto-enable test mode if before spring training
            const now = new Date();
            if (now < SPRING_TRAINING_START) {
                document.getElementById('test-mode').checked = true;
            }
            window.updateDateDisplay();
        });

        // 2. ADD PLAYER
        window.addPlayer = function() {
            const el = document.getElementById('p-input');
            if (!el || !el.value) return;
            const val = el.value.trim().toUpperCase();
            window.roster.push({ name: val, balance: 0 });
            el.value = "";
            window.draw();
        };

        // 3. DRAW LINEUP
        window.draw = function() {
            const listEl = document.getElementById('p-list');
            if (!listEl) return;
            listEl.innerHTML = window.roster.map((p, i) => 
                `<div class="bg-gray-900 p-3 rounded flex justify-between text-xs font-bold uppercase border border-gray-800 items-center mb-2">
                    <span class="truncate mr-2">${p.name}</span>
                    <button onclick="window.roster.splice(${i},1);window.draw()" class="text-red-500 font-black px-2 flex-shrink-0">X</button>
                </div>`
            ).join('');
        };

        // 4. FETCH GAMES (DYNAMIC DATE)
        window.findGames = async function(e) {
            try {
                const testMode = document.getElementById('test-mode').checked;
                const today = new Date().toISOString().split('T')[0];
                const fetchDate = testMode ? TEST_DATE : today;
                
                console.log(`Fetching games for ${fetchDate} (Test Mode: ${testMode})`);
                
                const resp = await fetch(`https://statsapi.mlb.com/api/v1/schedule/games/?sportId=1&date=${fetchDate}`);
                const data = await resp.json();
                const select = document.getElementById('game-select');
                if (!select) return;
                select.innerHTML = '<option value="">-- SELECT GAME --</option>';
                
                if (!data.dates || !data.dates[0] || !data.dates[0].games || data.dates[0].games.length === 0) {
                    alert(`No games found for ${fetchDate}. Try enabling Test Mode or selecting a different date.`);
                    return;
                }
                
                data.dates[0].games.forEach(g => {
                    let opt = document.createElement('option');
                    opt.value = g.gamePk;
                    
                    // Format game status
                    const status = g.status.detailedState;
                    let statusText = '';
                    
                    if (status === 'Scheduled' || status === 'Pre-Game') {
                        const gameTime = new Date(g.gameDate);
                        statusText = gameTime.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    } else if (status === 'In Progress' || status === 'Live') {
                        statusText = 'üî¥ LIVE';
                    } else if (status === 'Final') {
                        statusText = 'FINAL';
                    } else {
                        statusText = status;
                    }
                    
                    opt.text = `${g.teams.away.team.name.toUpperCase()} @ ${g.teams.home.team.name.toUpperCase()} (${statusText})`;
                    opt.dataset.status = status;
                    select.appendChild(opt);
                });
                
                select.classList.remove('hidden');
                if (e && e.target) e.target.classList.add('hidden');
                console.log(`${data.dates[0].games.length} games loaded successfully`);
            } catch (err) { 
                console.error("API Error:", err);
                alert("Error loading games. Check console for details.");
            }
        };

        // 5. START GAME
        window.startGame = async function() {
            if (window.roster.length < 2) return alert("ADD 2+ PLAYERS!");
            const sel = document.getElementById('game-select');
            if (!sel || !sel.value) return alert("SELECT A GAME!");

            window.gameName = sel.options[sel.selectedIndex].text;
            const gameStatus = sel.options[sel.selectedIndex].dataset.status;
            
            window.unit = parseFloat(document.getElementById('base-bet').value) || 5;
            window.r_id = Math.random().toString(36).substring(2, 6).toUpperCase();
            window.roster.forEach(p => p.balance = -window.unit);
            window.currentPot = window.unit * window.roster.length;

            document.getElementById('setup-area').classList.add('hidden');
            document.getElementById('remote').classList.remove('hidden');
            document.getElementById('game-title-display').innerText = window.gameName;
            document.getElementById('game-status-display').innerText = `Game ID: ${window.r_id}`;
            document.getElementById('pot-display').innerText = `$${window.currentPot.toFixed(2)}`;
            
            window.updateManagerUI(window.roster, 0);

            const { error } = await window.sb.from('games').insert([{
                id: window.r_id,
                players: window.roster,
                pot_total: window.currentPot,
                current_holder_index: 0,
                last_event: "PLAY BALL!"
            }]);
            
            if (error) {
                console.error("Supabase Error:", error);
                return alert("Supabase Error: " + error.message);
            }

            window.selectedGamePk = sel.value;
            
            // Adjust polling interval based on game status
            const pollSpeed = (gameStatus === 'In Progress' || gameStatus === 'Live') ? 5000 : 10000;
            window.pollInterval = setInterval(window.checkMLB, pollSpeed);
            
            console.log(`Game started! Polling every ${pollSpeed/1000} seconds... (Status: ${gameStatus})`);
        };

        // 6. REPLAY ENGINE
        window.checkMLB = async function() {
            try {
                const resp = await fetch(`https://statsapi.mlb.com/api/v1/game/${window.selectedGamePk}/playByPlay`);
                const data = await resp.json();
                const nextIdx = window.lastIdx + 1;
                
                if (!data.allPlays) {
                    console.log("No plays data yet...");
                    return;
                }
                
                // Check if we've reached the end
                if (nextIdx >= data.allPlays.length) {
                    console.log("Game over! All plays processed.");
                    clearInterval(window.pollInterval);
                    document.getElementById('pbp-text').innerText = "üèÅ GAME OVER - All plays complete";
                    window.runSettlement();
                    return;
                }
                
                if (data.allPlays[nextIdx]) {
                    const play = data.allPlays[nextIdx];
                    const event = (play.result.event || "").toLowerCase();
                    const desc = play.result.description || "In progress...";
                    
                    document.getElementById('pbp-text').innerText = desc;
                    document.getElementById('replay-status').innerText = `PLAY #${nextIdx + 1} OF ${data.allPlays.length}`;
                    
                    await window.processMove(event, desc);
                    window.lastIdx = nextIdx;
                }
            } catch (e) { 
                console.log("Feed check error:", e); 
            }
        };

        // 7. PROCESS MOVE
        window.processMove = async function(type, desc) {
            const { data } = await window.sb.from('games').select('*').eq('id', window.r_id);
            if (!data || !data[0]) return;
            
            const g = data[0];
            let pot = parseFloat(g.pot_total);
            let list = g.players;
            let i = g.current_holder_index;

            // GAME RULES
            if (type.includes('strikeout')) {
                pot += (window.unit * 2);
                list[i].balance -= (window.unit * 2);
                console.log(`‚öæ STRIKEOUT! ${list[i].name} pays $${window.unit * 2}`);
            } 
            else if (type.includes('walk') || type.includes('hit_by_pitch')) {
                console.log(`üö∂ WALK/HBP - no payment, rotating...`);
            }
            else if (type.includes('out') || type.includes('groundout') || type.includes('flyout') || 
                     type.includes('pop_out') || type.includes('lineout') || type.includes('field_out') ||
                     type.includes('force_out') || type.includes('grounded_into_double_play') ||
                     type.includes('sac_fly') || type.includes('sac_bunt')) {
                pot += window.unit;
                list[i].balance -= window.unit;
                console.log(`‚ùå OUT! ${list[i].name} pays $${window.unit}`);
            }
            else if (type.includes('single')) {
                let win = Math.min(pot, window.unit);
                pot -= win;
                list[i].balance += win;
                console.log(`üí∞ SINGLE! ${list[i].name} wins $${win}`);
            }
            else if (type.includes('double')) {
                let win = Math.min(pot, window.unit * 2);
                pot -= win;
                list[i].balance += win;
                console.log(`üí∞üí∞ DOUBLE! ${list[i].name} wins $${win}`);
            }
            else if (type.includes('triple')) {
                let win = Math.min(pot, window.unit * 3);
                pot -= win;
                list[i].balance += win;
                console.log(`üí∞üí∞üí∞ TRIPLE! ${list[i].name} wins $${win}`);
            }
            else if (type.includes('home_run')) {
                list[i].balance += pot;
                console.log(`üèÜ HOME RUN! ${list[i].name} wins ENTIRE POT: $${pot}`);
                pot = 0;
            }
            else {
                console.log(`‚ö†Ô∏è Unhandled event: ${type}`);
            }

            let next_i = (i + 1) % list.length;
            
            // Update pot display
            window.currentPot = pot;
            document.getElementById('pot-display').innerText = `$${pot.toFixed(2)}`;
            
            window.updateManagerUI(list, next_i);

            await window.sb.from('games').update({
                pot_total: pot,
                players: list,
                current_holder_index: next_i,
                last_event: desc
            }).eq('id', window.r_id);
        };

        // 8. UI REFRESH
        window.updateManagerUI = function(list, activeIdx) {
            const upNowEl = document.getElementById('up-now');
            if (upNowEl) upNowEl.innerText = list[activeIdx].name;
            
            const ledger = document.getElementById('ledger-list');
            if (!ledger) return;
            
            ledger.innerHTML = list.map((p, i) => 
                `<div class="flex justify-between items-center uppercase ${i === activeIdx ? 'text-blue-400 font-black' : 'text-gray-400'} mb-2 text-sm sm:text-base">
                    <span class="truncate mr-2">${i === activeIdx ? 'üç∫ ' : ''}${p.name}</span>
                    <span class="${p.balance < 0 ? 'text-red-500' : 'text-green-500'} font-mono whitespace-nowrap">
                        ${p.balance < 0 ? '-' : ''}$${Math.abs(p.balance).toFixed(2)}
                    </span>
                </div>`
            ).join('');
        };

        // 9. SETTLEMENT
        window.runSettlement = async function() {
            const { data } = await window.sb.from('games').select('*').eq('id', window.r_id);
            if (!data || data.length === 0) return;
            
            const g = data[0];
            const takers = g.players.filter(p => p.balance > 0);
            
            if (takers.length === 0) {
                document.getElementById('settlement-list').innerHTML = 
                    `<div class="p-4 text-center text-xs text-gray-500 border border-dashed border-gray-800 rounded-xl uppercase">
                        NO WINNERS YET. NEED AT LEAST ONE PERSON IN THE GREEN.
                    </div>`;
                document.getElementById('settlement-area').classList.remove('hidden');
                return;
            }
            
            const givers = g.players.filter(p => p.balance < 0).map(p => ({ n: p.name, a: Math.abs(p.balance) }));
            const tks = takers.map(p => ({ n: p.name, a: p.balance }));
            let txs = [], gi = 0, ti = 0;

            while (gi < givers.length && ti < tks.length) {
                let pay = Math.min(givers[gi].a, tks[ti].a);
                if (pay > 0.01) txs.push({ f: givers[gi].n, t: tks[ti].n, a: pay.toFixed(2) });
                givers[gi].a -= pay;
                tks[ti].a -= pay;
                if (givers[gi].a < 0.01) gi++;
                if (tks[ti].a < 0.01) ti++;
            }

            document.getElementById('settlement-list').innerHTML = txs.map(t => `
                <div class="bg-gray-900 p-4 sm:p-5 rounded-2xl sm:rounded-3xl border-2 border-gray-800 flex flex-col items-center mb-2 shadow-inner uppercase font-black">
                    <div class="flex justify-between w-full italic text-xs sm:text-sm gap-2">
                        <span class="text-red-500 truncate">${t.f}</span>
                        <span class="text-white text-xl sm:text-2xl tabular-nums whitespace-nowrap">$${t.a}</span>
                        <span class="text-green-500 truncate">${t.t}</span>
                    </div>
                    <div class="text-[9px] text-gray-500 tracking-[0.4em] mt-1">PAYS</div>
                </div>`).join('');
            
            document.getElementById('settlement-area').classList.remove('hidden');
            document.getElementById('manager-controls').classList.add('hidden');
        };

        // 10. SHARE LINK
        window.copyShareLink = function(btn) {
            const url = window.location.origin + window.location.pathname.replace('setup.html', 'index.html') + "?id=" + window.r_id;
            navigator.clipboard.writeText(url).then(() => {
                btn.innerText = "‚úÖ COPIED!";
                setTimeout(() => btn.innerText = "üîó SCOREBOARD LINK", 2000);
            }).catch(err => {
                alert("Copy failed. Link: " + url);
            });
        };
    </script>
</body>
</html>
