const S_URL = 'https://yhywgwohyzrcbzgxxtyb.supabase.co';
        const S_KEY = 'sb_publishable_zYteMuxmxLbR0mxUDe8a3w_8brmZ2sv';
        const sb = supabase.createClient(S_URL, S_KEY);
        let roster = [], r_id = "", selectedGamePk = null, lastIdx = -1, unit = 5, gameName = "";

        function addPlayer() {
            const val = document.getElementById('p-input').value.trim().toUpperCase();
            if (val) { roster.push({ name: val, balance: 0 }); document.getElementById('p-input').value = ""; draw(); }
        }

        function draw() {
            document.getElementById('p-list').innerHTML = roster.map((p, i) => `<div class="bg-gray-900 p-3 rounded flex justify-between text-xs font-bold uppercase"><span>${p.name}</span><button onclick="roster.splice(${i},1);draw()">X</button></div>`).join('');
        }

        async function findGames(e) {
            const resp = await fetch(`https://statsapi.mlb.com/api/v1/schedule/games/?sportId=1&date=2025-07-10`);
            const data = await resp.json();
            const select = document.getElementById('game-select');
            select.innerHTML = '<option value="">-- Select Game --</option>';
            data.dates[0].games.forEach(g => { 
                let opt = document.createElement('option'); 
                opt.value = g.gamePk; 
                opt.text = `${g.teams.away.team.name} @ ${g.teams.home.team.name}`; 
                select.appendChild(opt); 
            });
            select.classList.remove('hidden'); e.target.classList.add('hidden');
        }

        async function startGame() {
            if (roster.length < 2) return alert("Add 2+ players!");
            const sel = document.getElementById('game-select');
            gameName = sel.options[sel.selectedIndex].text;
            unit = parseFloat(document.getElementById('base-bet').value);
            r_id = Math.random().toString(36).substring(2, 6).toUpperCase();
            roster.forEach(p => p.balance = -unit);

            document.getElementById('setup-area').classList.add('hidden');
            document.getElementById('remote').classList.remove('hidden');
            document.getElementById('game-title-display').innerText = gameName;
            
            updateUI(roster, 0);
            
            await sb.from('games').insert([{ id: r_id, players: roster, pot_total: (unit * roster.length), current_holder_index: 0, last_event: "Play Ball!", game_name: gameName }]);
            selectedGamePk = sel.value;
            if(selectedGamePk) setInterval(checkMLB, 15000);
        }

        async function checkMLB() {
            try {
                const resp = await fetch(`https://statsapi.mlb.com/api/v1/game/${selectedGamePk}/playByPlay`);
                const data = await resp.json();
                if (!data || !data.allPlays) return;
                const nextIdx = lastIdx + 1;
                if (data.allPlays[nextIdx]) {
                    const play = data.allPlays[nextIdx];
                    document.getElementById('pbp-text').innerText = play.result.description;
                    document.getElementById('replay-status').innerText = `Play #${nextIdx + 1} of ${data.allPlays.length}`;
                    move(play.result.event.toLowerCase(), play.result.description);
                    lastIdx = nextIdx;
                }
            } catch(e) { console.error("Feed Error:", e); }
        }

        async function move(type, desc) {
            try {
                // Fetching without .single() to avoid 406 errors
                let { data, error } = await sb.from('games').select('*').eq('id', r_id);
                if (error || !data || data.length === 0) return;
                
                let g = data[0];
                let pot = parseFloat(g.pot_total), list = g.players, i = g.current_holder_index;
                
                if (type.includes('strikeout')){ pot += (unit*2); list[i].balance -= (unit*2); }
                else if (type.includes('out')){ pot += unit; list[i].balance -= unit; }
                else if (type.includes('single')){ let a=Math.min(pot,unit); pot-=a; list[i].balance+=a; }
                else if (type.includes('hr')){ list[i].balance+=pot; pot=0; }
                
                let next_i = (i + 1) % list.length;
                updateUI(list, next_i);
                
                await sb.from('games').update({ 
                    pot_total: pot, 
                    players: list, 
                    current_holder_index: next_i, 
                    last_event: desc 
                }).eq('id', r_id);
            } catch(e) { console.error("Move Error:", e); }
        }

        function updateUI(list, idx) {
            document.getElementById('up-now').innerText = list[idx].name;
            document.getElementById('ledger-list').innerHTML = list.map((p, i) => `
                <div class="flex justify-between items-center uppercase ${i === idx ? 'text-blue-400' : 'text-gray-400'}">
                    <span>${i === idx ? 'üç∫ ' : ''}${p.name}</span>
                    <span class="${p.balance < 0 ? 'text-red-500' : 'text-green-500'}">${p.balance < 0 ? '-' : ''}$${Math.abs(p.balance).toFixed(2)}</span>
                </div>`).join('');
        }

        async function runSettlement() {
            let { data } = await sb.from('games').select('*').eq('id', r_id);
            if(!data || data.length === 0) return;
            let g = data[0];
            let takers = g.players.filter(p => p.balance > 0);
            if (takers.length === 0) {
                document.getElementById('settlement-list').innerHTML = `<div class="bg-gray-900 p-6 rounded-3xl border-2 border-dashed border-gray-800 text-center text-xs uppercase text-gray-500">No Winners Yet.</div>`;
                document.getElementById('settlement-area').classList.remove('hidden');
                return;
            }
            let givers = g.players.filter(p => p.balance < 0).map(p => ({ n: p.name, a: Math.abs(p.balance) }));
            let tks = takers.map(p => ({ n: p.name, a: p.balance }));
            let txs = [], gi=0, ti=0;
            while(gi < givers.length && ti < tks.length) {
                let pay = Math.min(givers[gi].a, tks[ti].a);
                if(pay > 0.01) txs.push({ f: givers[gi].n, t: tks[ti].n, a: pay.toFixed(2) });
                givers[gi].a -= pay; tks[ti].a -= pay;
                if(givers[gi].a < 0.01) gi++; if(tks[ti].a < 0.01) ti++;
            }
            document.getElementById('settlement-list').innerHTML = txs.map(t => `
                <div class="bg-gray-900 p-6 rounded-3xl border-2 border-gray-800 flex flex-col items-center mb-2">
                    <div class="flex justify-between w-full font-black uppercase italic text-sm"><span class="text-red-500">${t.f}</span><span class="text-white text-2xl">$${t.a}</span><span class="text-green-500">${t.t}</span></div>
                    <div class="text-[9px] font-black text-gray-500 tracking-[0.4em]">PAYS</div>
                </div>`).join('');
            document.getElementById('settlement-area').classList.remove('hidden');
            document.getElementById('manager-controls').classList.add('hidden');
        }

        function copyShareLink(btn) {
            navigator.clipboard.writeText(window.location.origin + "/index.html?id=" + r_id).then(() => { btn.innerText = "COPIED!"; setTimeout(() => btn.innerText = "üîó Scoreboard Link", 2000); });
        }
