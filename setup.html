const S_URL = 'https://yhywgwohyzrcbzgxxtyb.supabase.co';
const S_KEY = 'sb_publishable_zYteMuxmxLbR0mxUDe8a3w_8brmZ2sv';
const sb = supabase.createClient(S_URL, S_KEY);

let roster = [], r_id = "", selectedGamePk = null, lastIdx = -1, gameName = "", unit = 5;
let pollInterval = null; // Store interval to clear it later

// 1. DYNAMIC DATE FETCH
async function findGames(e) {
    const today = new Date().toISOString().split('T')[0]; // Get current date
    try {
        const resp = await fetch(`https://statsapi.mlb.com/api/v1/schedule/games/?sportId=1&date=${today}`);
        const data = await resp.json();
        const select = document.getElementById('game-select');
        select.innerHTML = '<option value="">-- SELECT LIVE GAME --</option>';
        
        if (data.dates && data.dates[0]) {
            data.dates[0].games.forEach(g => {
                let opt = document.createElement('option');
                opt.value = g.gamePk;
                opt.text = `${g.teams.away.team.name.toUpperCase()} @ ${g.teams.home.team.name.toUpperCase()} (${g.status.abstractGameState})`;
                select.appendChild(opt);
            });
            select.classList.remove('hidden');
            e.target.classList.add('hidden');
        } else {
            alert("No games found for today. Reverting to July 10, 2025 for testing.");
            fetchTestGames();
        }
    } catch (err) { console.error("Fetch Error:", err); }
}

// 2. START GAME
async function startGame() {
    if (roster.length < 2) return alert("ADD 2+ PLAYERS!");
    const sel = document.getElementById('game-select');
    if (!sel.value) return alert("SELECT A GAME!");

    gameName = sel.options[sel.selectedIndex].text;
    unit = parseFloat(document.getElementById('base-bet').value); 
    r_id = Math.random().toString(36).substring(2, 6).toUpperCase();
    
    roster.forEach(p => p.balance = -unit);

    document.getElementById('setup-area').classList.add('hidden');
    document.getElementById('remote').classList.remove('hidden');
    document.getElementById('game-title-display').innerText = gameName;
    
    updateManagerUI(roster, 0);

    const { error } = await sb.from('games').insert([{ 
        id: r_id, 
        players: roster, 
        pot_total: (unit * roster.length), 
        current_holder_index: 0, 
        last_event: "PLAY BALL!", 
        game_name: gameName 
    }]);

    if (error) return alert("Supabase Connection Failed!");

    selectedGamePk = sel.value;
    pollInterval = setInterval(checkMLB, 15000); // Start controlled polling
}

// 3. ENHANCED EVENT HANDLING
async function processMove(type, desc) {
    try {
        const { data, error } = await sb.from('games').select('*').eq('id', r_id);
        if (error || !data || data.length === 0) return;
        
        const g = data[0];
        let pot = parseFloat(g.pot_total);
        let list = g.players;
        let i = g.current_holder_index;

        // EXPANDED EVENT LOGIC
        if (type.includes('strikeout')) { pot += (unit * 2); list[i].balance -= (unit * 2); } 
        else if (type.includes('out') || type.includes('fielder_choice')) { pot += unit; list[i].balance -= unit; } 
        else if (type.includes('single') || type.includes('double') || type.includes('triple') || type.includes('walk') || type.includes('hit_by_pitch')) { 
            let win = Math.min(pot, unit); 
            pot -= win; 
            list[i].balance += win; 
        } 
        else if (type.includes('home_run')) { 
            list[i].balance += pot; 
            pot = 0; 
        }
        // Ignores non-play events (stolen bases, etc.) to keep cup moving on ABs

        let next_i = (i + 1) % list.length;
        updateManagerUI(list, next_i);

        await sb.from('games').update({ 
            pot_total: pot, 
            players: list, 
            current_holder_index: next_i, 
            last_event: desc 
        }).eq('id', r_id);
    } catch (e) { console.error("Move Error:", e); }
}

// 4. GAME END DETECTION
async function checkMLB() {
    try {
        const resp = await fetch(`https://statsapi.mlb.com/api/v1/game/${selectedGamePk}/playByPlay`);
        const data = await resp.json();
        
        if (!data || !data.allPlays) return;

        // Check if we've reached the end of the available plays
        if (lastIdx >= data.allPlays.length - 1) {
            const gameStatus = await fetch(`https://statsapi.mlb.com/api/v1/game/${selectedGamePk}/contextMetrics`);
            const statusData = await gameStatus.json();
            if (statusData.game && statusData.game.status.abstractGameState === 'Final') {
                clearInterval(pollInterval);
                runSettlement();
                return;
            }
            return; // Just wait for next play
        }

        const nextIdx = lastIdx + 1;
        const play = data.allPlays[nextIdx];
        document.getElementById('pbp-text').innerText = play.result.description;
        await processMove(play.result.event.toLowerCase(), play.result.description);
        lastIdx = nextIdx;
        
    } catch (e) { console.error("Feed Error:", e); }
}
