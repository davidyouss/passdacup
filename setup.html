const S_URL = 'https://yhywgwohyzrcbzgxxtyb.supabase.co';
const S_KEY = 'sb_publishable_zYteMuxmxLbR0mxUDe8a3w_8brmZ2sv';
const sb = supabase.createClient(S_URL, S_KEY);

let roster = [], r_id = "", selectedGamePk = null, lastIdx = -1, gameName = "", unit = 5;

// 1. ADD PLAYER TO LINEUP
function addPlayer() {
    const el = document.getElementById('p-input');
    const val = el.value.trim().toUpperCase();
    if (val) {
        roster.push({ name: val, balance: 0 });
        el.value = "";
        draw();
    }
}

// 2. DRAW PRE-GAME LIST
function draw() {
    const listEl = document.getElementById('p-list');
    listEl.innerHTML = roster.map((p, i) => 
        `<div class="bg-gray-900 p-3 rounded flex justify-between text-xs font-bold uppercase border border-gray-800 items-center mb-2">
            <span>${p.name}</span>
            <button onclick="roster.splice(${i},1);draw()" class="text-red-500 font-black px-2">X</button>
        </div>`
    ).join('');
}

// 3. FETCH HISTORICAL GAMES
async function findGames(e) {
    try {
        const resp = await fetch('https://statsapi.mlb.com/api/v1/schedule/games/?sportId=1&date=2025-07-10');
        const data = await resp.json();
        const select = document.getElementById('game-select');
        select.innerHTML = '<option value="">-- SELECT GAME --</option>';
        if (data.dates && data.dates[0]) {
            data.dates[0].games.forEach(g => {
                let opt = document.createElement('option');
                opt.value = g.gamePk;
                opt.text = `${g.teams.away.team.name.toUpperCase()} @ ${g.teams.home.team.name.toUpperCase()}`;
                select.appendChild(opt);
            });
            select.classList.remove('hidden');
            e.target.classList.add('hidden');
        }
    } catch (err) { console.error("Fetch Error:", err); }
}

// 4. START GAME SESSION
async function startGame() {
    if (roster.length < 2) return alert("ADD 2+ PLAYERS!");
    const sel = document.getElementById('game-select');
    if (!sel.value) return alert("SELECT A GAME FIRST!");

    gameName = sel.options[sel.selectedIndex].text;
    unit = parseFloat(document.getElementById('base-bet').value); 
    r_id = Math.random().toString(36).substring(2, 6).toUpperCase();
    
    // Set buy-in debt
    roster.forEach(p => p.balance = -unit);

    document.getElementById('setup-area').classList.add('hidden');
    document.getElementById('remote').classList.remove('hidden');
    document.getElementById('game-title-display').innerText = gameName;
    
    updateManagerUI(roster, 0);

    await sb.from('games').insert([{ 
        id: r_id, 
        players: roster, 
        pot_total: (unit * roster.length), 
        current_holder_index: 0, 
        last_event: "PLAY BALL!", 
        game_name: gameName 
    }]);

    selectedGamePk = sel.value;
    setInterval(checkMLB, 15000); // 15s refresh
}

// 5. POLL MLB FEED (HISTORICAL PLAYBACK)
async function checkMLB() {
    try {
        const resp = await fetch(`https://statsapi.mlb.com/api/v1/game/${selectedGamePk}/playByPlay`);
        const data = await resp.json();
        if (!data || !data.allPlays) return;

        const nextIdx = lastIdx + 1;
        if (data.allPlays[nextIdx]) {
            const play = data.allPlays[nextIdx];
            const desc = play.result.description;
            const eventType = play.result.event.toLowerCase();
            
            document.getElementById('pbp-text').innerText = desc;
            document.getElementById('replay-status').innerText = `PLAY #${nextIdx + 1} OF ${data.allPlays.length}`;
            
            await processMove(eventType, desc);
            lastIdx = nextIdx;
        }
    } catch (e) { console.error("Feed Error:", e); }
}

// 6. CALCULATE BALANCES & SYNC SUPABASE
async function processMove(type, desc) {
    try {
        // Fetch current state using array-fetch to avoid 406 errors
        const { data, error } = await sb.from('games').select('*').eq('id', r_id);
        if (error || !data || data.length === 0) return;
        
        const g = data[0];
        let pot = parseFloat(g.pot_total);
        let list = g.players;
        let i = g.current_holder_index;

        // Logic based on event type
        if (type.includes('strikeout')) { pot += (unit * 2); list[i].balance -= (unit * 2); } 
        else if (type.includes('out')) { pot += unit; list[i].balance -= unit; } 
        else if (type.includes('single')) { let win = Math.min(pot, unit); pot -= win; list[i].balance += win; } 
        else if (type.includes('hr')) { list[i].balance += pot; pot = 0; }

        let next_i = (i + 1) % list.length;
        
        // Immediate UI refresh for Manager
        updateManagerUI(list, next_i);

        // Update Cloud
        await sb.from('games').update({ 
            pot_total: pot, 
            players: list, 
            current_holder_index: next_i, 
            last_event: desc 
        }).eq('id', r_id);
    } catch (e) { console.error("Move Error:", e); }
}

// 7. REFRESH MANAGER STANDINGS LEDGER
function updateManagerUI(list, activeIdx) {
    document.getElementById('up-now').innerText = list[activeIdx].name;
    const ledger = document.getElementById('ledger-list');
    ledger.innerHTML = list.map((p, i) => 
        `<div class="flex justify-between items-center uppercase ${i === activeIdx ? 'text-blue-400 font-black' : 'text-gray-400'} mb-2">
            <span>${i === activeIdx ? 'üç∫ ' : ''}${p.name}</span>
            <span class="${p.balance < 0 ? 'text-red-500' : 'text-green-500'} font-mono">
                ${p.balance < 0 ? '-' : ''}$${Math.abs(p.balance).toFixed(2)}
            </span>
        </div>`
    ).join('');
}

// 8. FINAL SETTLEMENT MATH
async function runSettlement() {
    const { data } = await sb.from('games').select('*').eq('id', r_id);
    if (!data || data.length === 0) return;
    const g = data[0];
    const takers = g.players.filter(p => p.balance > 0);
    
    if (takers.length === 0) {
        document.getElementById('settlement-list').innerHTML = 
            `<div class="p-4 text-center text-xs text-gray-500 border border-dashed border-gray-800 rounded-xl uppercase">
                NO WINNERS YET. NEED AT LEAST ONE PERSON IN THE GREEN.
            </div>`;
        document.getElementById('settlement-area').classList.remove('hidden');
        return;
    }
    
    const givers = g.players.filter(p => p.balance < 0).map(p => ({ n: p.name, a: Math.abs(p.balance) }));
    const tks = takers.map(p => ({ n: p.name, a: p.balance }));
    let txs = [], gi = 0, ti = 0;

    while (gi < givers.length && ti < tks.length) {
        let pay = Math.min(givers[gi].a, tks[ti].a);
        if (pay > 0.01) txs.push({ f: givers[gi].n, t: tks[ti].n, a: pay.toFixed(2) });
        givers[gi].a -= pay; tks[ti].a -= pay;
        if (givers[gi].a < 0.01) gi++; if (tks[ti].a < 0.01) ti++;
    }

    document.getElementById('settlement-list').innerHTML = txs.map(t => `
        <div class="bg-gray-900 p-5 rounded-3xl border-2 border-gray-800 flex flex-col items-center mb-2 shadow-inner uppercase font-black">
            <div class="flex justify-between w-full italic text-sm">
                <span class="text-red-500">${t.f}</span>
                <span class="text-white text-2xl tabular-nums">$${t.a}</span>
                <span class="text-green-500">${t.t}</span>
            </div>
            <div class="text-[9px] text-gray-500 tracking-[0.4em] mt-1">PAYS</div>
        </div>`).join('');
    
    document.getElementById('settlement-area').classList.remove('hidden');
    document.getElementById('manager-controls').classList.add('hidden');
}

// 9. SHARE LINK
function copyShareLink(btn) {
    const url = window.location.origin + window.location.pathname.replace('setup.html', 'index.html') + "?id=" + r_id;
    navigator.clipboard.writeText(url).then(() => {
        btn.innerText = "COPIED!";
        setTimeout(() => btn.innerText = "üîó SCOREBOARD LINK", 2000);
    });
}
