<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pass Da Cup - Live Scoreboard</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
        }
    </style>
</head>
<body class="bg-black text-white min-h-screen p-4 sm:p-8">
    
    <div class="max-w-2xl mx-auto">
        
        <!-- Compact header -->
        <div class="text-center mb-4">
            <h1 class="text-2xl sm:text-4xl font-black mb-1" id="game-title">LIVE SESSION</h1>
            <p class="text-gray-600 text-xs uppercase tracking-wider">Scoreboard</p>
        </div>

        <!-- Currently At Bat - Compact -->
        <div class="bg-gradient-to-r from-blue-900 to-blue-800 rounded-xl p-3 sm:p-4 mb-3 border-2 border-blue-700 text-center">
            <p class="text-gray-400 text-xs uppercase mb-1">Currently At Bat</p>
            <p id="up-now" class="text-2xl sm:text-3xl font-black">-</p>
        </div>

        <!-- Pot Display - Smaller -->
        <div class="bg-gradient-to-r from-green-900 to-green-800 rounded-xl p-4 sm:p-5 mb-3 border-2 border-green-700 text-center">
            <p id="pot-display" class="text-4xl sm:text-5xl font-black font-mono">$0.00</p>
        </div>

        <!-- Play by Play - Compact -->
        <div class="bg-gray-900 rounded-xl p-3 sm:p-4 mb-3 border-2 border-gray-800">
            <div class="flex justify-between items-center mb-2">
                <h2 class="text-xs font-black uppercase text-gray-500">Live Feed</h2>
                <span id="sync-time" class="text-[10px] text-gray-600"></span>
            </div>
            <p id="pbp-text" class="text-white italic text-xs sm:text-sm leading-relaxed">Waiting for updates...</p>
        </div>

        <!-- Standings - Compact -->
        <div class="bg-gray-900 rounded-xl p-3 sm:p-4 border-2 border-gray-800">
            <h2 class="text-base sm:text-lg font-black mb-3 uppercase">Standings</h2>
            <div id="ledger-list"></div>
        </div>
    </div>

    <script>
        // Supabase setup
        const S_URL = 'https://yhywgwohyzrcbzgxxtyb.supabase.co';
        const S_KEY = 'sb_publishable_zYteMuxmxLbR0mxUDe8a3w_8brmZ2sv';
        const sb = supabase.createClient(S_URL, S_KEY);

        // Get game ID from URL
        const params = new URLSearchParams(window.location.search);
        const gameId = params.get('id');

        if (!gameId) {
            document.body.innerHTML = '<div class="text-center mt-20"><h1 class="text-4xl font-black mb-4">‚ùå NO GAME ID</h1><p class="text-gray-500">Please use the link from the manager.</p></div>';
        } else {
            // Load initial data
            loadGame();
            
            // Set up real-time subscription
            const channel = sb.channel('game-updates')
                .on('postgres_changes', 
                    { event: 'UPDATE', schema: 'public', table: 'games', filter: `id=eq.${gameId}` },
                    (payload) => {
                        console.log('Game updated!', payload);
                        updateUI(payload.new);
                    }
                )
                .subscribe();

            // Also poll every 5 seconds as backup
            setInterval(loadGame, 5000);
        }

        async function loadGame() {
            try {
                const { data, error } = await sb
                    .from('games')
                    .select('*')
                    .eq('id', gameId)
                    .single();

                if (error) throw error;
                if (data) updateUI(data);
            } catch (err) {
                console.error('Error loading game:', err);
            }
        }

        function updateUI(game) {
            // Update sync time
            const now = new Date();
            document.getElementById('sync-time').innerText = now.toLocaleTimeString('en-US', { 
                hour: 'numeric', 
                minute: '2-digit',
                second: '2-digit'
            });

            // Update game title if available
            if (game.game_name) {
                document.getElementById('game-title').innerText = game.game_name;
            }

            // Update pot
            const pot = parseFloat(game.pot_total || 0);
            document.getElementById('pot-display').innerText = `$${pot.toFixed(2)}`;

            // Update current player
            const players = game.players || [];
            const currentIdx = game.current_holder_index || 0;
            if (players[currentIdx]) {
                document.getElementById('up-now').innerText = players[currentIdx].name;
            }

            // Update play-by-play
            if (game.last_event) {
                document.getElementById('pbp-text').innerText = game.last_event;
            }

            // Update standings
            const ledger = document.getElementById('ledger-list');
            ledger.innerHTML = players.map((p, i) => 
                `<div class="flex justify-between items-center mb-2 text-sm sm:text-base ${i === currentIdx ? 'text-blue-400 font-black' : 'text-gray-400'}">
                    <span class="truncate mr-2">${i === currentIdx ? 'üç∫ ' : ''}${p.name}</span>
                    <span class="${p.balance < 0 ? 'text-red-500' : 'text-green-500'} font-mono whitespace-nowrap">
                        ${p.balance < 0 ? '-' : ''}$${Math.abs(p.balance).toFixed(2)}
                    </span>
                </div>`
            ).join('');
        }
    </script>
</body>
</html>
