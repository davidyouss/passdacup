<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager | Pass The Cup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-black text-white p-6 font-sans">
    <div class="max-w-md mx-auto space-y-6">
        <h1 class="text-2xl font-black italic text-yellow-500 uppercase tracking-tighter text-center">Cup Manager Pro</h1>

        <div id="rejoin-area" class="bg-gray-900 border border-yellow-500/30 p-4 rounded-xl space-y-2">
            <p class="text-[10px] font-bold text-yellow-500 uppercase tracking-widest text-center">Already have a game?</p>
            <div class="flex gap-2">
                <input id="rejoin-id" type="text" placeholder="CODE" class="flex-grow bg-black border border-gray-800 p-2 rounded text-center font-mono uppercase">
                <button onclick="rejoinGame()" class="bg-yellow-500 text-black px-4 rounded font-black text-xs">RE-JOIN</button>
            </div>
        </div>

        <div id="setup-area" class="space-y-4 pt-4 border-t border-gray-800">
            <div class="space-y-2">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">1. Add Lineup</p>
                <div class="flex gap-2">
                    <input id="p-input" type="text" placeholder="Name" class="flex-grow bg-gray-900 border border-gray-800 p-3 rounded-lg outline-none font-bold">
                    <button id="add-btn" class="bg-blue-600 px-6 rounded-lg font-black text-xl">+</button>
                </div>
                <div id="p-list" class="space-y-2 mt-2"></div>
            </div>

            <div class="space-y-2">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">2. Set Base Bet (Unit)</p>
                <select id="base-bet" class="w-full bg-gray-900 border border-gray-800 p-3 rounded-lg font-bold text-green-500">
                    <option value="1">$1.00</option>
                    <option value="2">$2.00</option>
                    <option value="5" selected>$5.00</option>
                    <option value="10">$10.00</option>
                </select>
            </div>

            <div class="space-y-2">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">3. Select MLB Game</p>
                <button onclick="findGames()" class="w-full bg-gray-800 p-3 rounded-lg text-xs font-bold uppercase border border-gray-700">Find Games (Test Date Active)</button>
                <select id="game-select" class="w-full bg-gray-900 border border-gray-800 p-3 rounded-lg text-sm hidden font-bold text-yellow-500"></select>
            </div>

            <button id="go-btn" class="w-full bg-yellow-500 text-black font-black py-4 rounded-xl uppercase shadow-lg shadow-yellow-500/20">Start New Game</button>
        </div>

        <div id="remote" class="hidden space-y-4 border-t-2 border-dashed border-gray-800 pt-6">
            <div class="flex justify-between items-center text-[10px] font-bold">
                <div id="live-indicator" class="text-green-500 animate-pulse hidden">‚óè MLB AUTO-SYNC</div>
                <div id="room-display" class="text-yellow-500 font-mono">CODE: ----</div>
            </div>
            
            <div class="bg-blue-600 p-4 rounded-xl text-center">
                <p class="text-[9px] font-black uppercase text-blue-100">Cup is with:</p>
                <h2 id="up-now" class="text-3xl font-black uppercase italic italic tracking-tighter">---</h2>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <button onclick="move('strikeout', this)" class="bg-gray-900 border-2 border-gray-800 py-4 rounded-xl font-black uppercase text-[10px]">K (Base x2)</button>
                <button onclick="move('out', this)" class="bg-gray-900 border-2 border-gray-800 py-4 rounded-xl font-black uppercase text-[10px]">OUT (Base x1)</button>
                <button onclick="move('single', this)" class="bg-gray-900 border-2 border-gray-800 py-4 rounded-xl font-black uppercase text-[10px]">1B (-Base)</button>
                <button onclick="move('double', this)" class="bg-gray-900 border-2 border-gray-800 py-4 rounded-xl font-black uppercase text-[10px]">2B (-Base x2)</button>
                <button onclick="move('triple', this)" class="bg-gray-900 border-2 border-gray-800 py-4 rounded-xl font-black uppercase text-[10px]">3B (-Base x3)</button>
                <button onclick="move('hr', this)" class="bg-yellow-500 text-black py-4 rounded-xl font-black uppercase text-[10px]">HR (CLEAR)</button>
                <button onclick="move('eject', this)" class="bg-red-600 text-white py-4 rounded-xl font-black uppercase text-[10px] col-span-2">üö® PLAYER EJECTED (+$100) üö®</button>
            </div>

            <div class="bg-gray-900 p-3 rounded-xl border border-gray-800 text-center">
                <p id="pbp-text" class="text-[11px] italic text-gray-400">Waiting for first play...</p>
            </div>

            <div id="settlement-area" class="mt-4 border-t-2 border-red-900 pt-6 hidden">
                <h3 class="text-center text-red-500 font-black uppercase text-sm mb-4 italic">Final Settlement</h3>
                <div id="settlement-list" class="space-y-2 mb-4"></div>
                <button onclick="location.reload()" class="w-full bg-gray-800 text-gray-400 py-2 rounded-lg text-[10px] font-bold uppercase">Reset App</button>
            </div>

            <button id="end-game-btn" onclick="runSettlement()" class="w-full bg-red-600/20 text-red-500 border border-red-600 font-black py-4 rounded-xl text-xs uppercase mt-4">üèÅ End Game & Settle Up</button>
            <button id="copy-btn" onclick="copyScoreboardLink(this)" class="w-full bg-white text-black font-black py-3 rounded-xl text-[10px] uppercase">Copy Scoreboard Link</button>
        </div>
    </div>

    <script>
        const S_URL = 'https://yhywgwohyzrcbzgxxtyb.supabase.co';
        const S_KEY = 'sb_publishable_zYteMuxmxLbR0mxUDe8a3w_8brmZ2sv';
        const sb = supabase.createClient(S_URL, S_KEY);

        let roster = [], r_id = "", selectedGamePk = null, lastIdx = -1, scoreboardLink = "";

        // RE-JOIN
        async function rejoinGame() {
            const code = document.getElementById('rejoin-id').value.trim().toUpperCase();
            const { data, error } = await sb.from('games').select('*').eq('id', code).single();
            if (error) return alert("Game not found!");
            r_id = data.id; roster = data.players;
            switchToRemote(data.current_holder_index);
        }

        function switchToRemote(idx) {
            document.getElementById('setup-area').classList.add('hidden');
            document.getElementById('rejoin-area').classList.add('hidden');
            document.getElementById('remote').classList.remove('hidden');
            document.getElementById('room-display').innerText = `CODE: ${r_id}`;
            document.getElementById('up-now').innerText = roster[idx].name;
            scoreboardLink = window.location.origin + "/index.html?id=" + r_id;
        }

        // SETUP
        document.getElementById('add-btn').onclick = () => {
            const el = document.getElementById('p-input');
            if (el.value.trim()) { roster.push({ name: el.value.trim(), balance: 0 }); el.value = ""; draw(); }
        };

        function draw() {
            document.getElementById('p-list').innerHTML = roster.map((p, i) => 
                `<div class="bg-gray-900 p-2 rounded flex justify-between text-xs border border-gray-800"><span>${p.name}</span><button onclick="roster.splice(${i},1);draw()">X</button></div>`
            ).join('');
        }

        // START GAME
        document.getElementById('go-btn').onclick = async () => {
            if (roster.length === 0) return alert("Add players!");
            const bet = parseFloat(document.getElementById('base-bet').value);
            r_id = Math.random().toString(36).substring(2, 6).toUpperCase();
            
            roster.forEach(p => { p.balance = -bet; p.unit = bet; });
            const startPot = bet * roster.length;

            const { error } = await sb.from('games').insert([{ 
                id: r_id, players: roster, pot_total: startPot, current_holder_index: 0, last_event: "Play Ball!" 
            }]);

            if (error) alert(error.message);
            else {
                selectedGamePk = document.getElementById('game-select').value;
                switchToRemote(0);
                if(selectedGamePk) {
                    document.getElementById('live-indicator').classList.remove('hidden');
                    setInterval(checkMLB, 15000);
                }
            }
        };

        // MLB LOGIC
        async function findGames() {
            const resp = await fetch(`https://statsapi.mlb.com/api/v1/schedule/games/?sportId=1&date=2025-07-10`);
            const data = await resp.json();
            const select = document.getElementById('game-select');
            select.innerHTML = '<option value="">-- Select Game --</option>';
            data.dates[0].games.forEach(g => {
                let opt = document.createElement('option'); opt.value = g.gamePk;
                opt.text = `${g.teams.away.team.name} @ ${g.teams.home.team.name}`;
                select.appendChild(opt);
            });
            select.classList.remove('hidden');
        }

        async function checkMLB() {
            if (!selectedGamePk) return;
            const resp = await fetch(`https://statsapi.mlb.com/api/v1/game/${selectedGamePk}/playByPlay`);
            const data = await resp.json();
            const nextIdx = lastIdx + 1;
            if (data.allPlays[nextIdx]) {
                const play = data.allPlays[nextIdx];
                if (play.result && play.result.description) {
                    document.getElementById('pbp-text').innerText = play.result.description;
                    processPlay(play.result.event.toLowerCase());
                    lastIdx = nextIdx;
                }
            }
        }

        function processPlay(ev) {
            if (ev.includes('strikeout')) move('strikeout');
            else if (ev.includes('out')) move('out');
            else if (ev.includes('single')) move('single');
            else if (ev.includes('double')) move('double');
            else if (ev.includes('triple')) move('triple');
            else if (ev.includes('home_run')) move('hr');
        }

        // MOVEMENT MATH
        async function move(type, btn) {
            if (btn) btn.style.opacity = "0.5";
            let { data: g } = await sb.from('games').select('*').eq('id', r_id).single();
            let pot = parseFloat(g.pot_total), list = g.players, i = g.current_holder_index, msg = "";
            const unit = list[0].unit || 5;

            if (type==='strikeout'){ let a=unit*2; pot+=a; list[i].balance-=a; msg=`K (+$${a})`; }
            else if (type==='out'){ let a=unit; pot+=a; list[i].balance-=a; msg=`Out (+$${a})`; }
            else if (type==='single'){ let a=Math.min(pot,unit); pot-=a; list[i].balance+=a; msg=`1B (-$${a})`; }
            else if (type==='double'){ let a=Math.min(pot,unit*2); pot-=a; list[i].balance+=a; msg=`2B (-$${a})`; }
            else if (type==='triple'){ let a=Math.min(pot,unit*3); pot-=a; list[i].balance+=a; msg=`3B (-$${a})`; }
            else if (type==='hr'){ list[i].balance+=pot; msg=`HR (+$${pot.toFixed(2)})`; pot=0; }
            else if (type==='eject'){ pot+=100; list[i].balance-=100; msg=`EJECTED (+$100)`; }

            let next_i = (i + 1) % list.length;
            document.getElementById('up-now').innerText = list[next_i].name;
            await sb.from('games').update({ pot_total: pot, players: list, current_holder_index: next_i, last_event: `${list[i].name}: ${msg}` }).eq('id', r_id);
            if (btn) btn.style.opacity = "1";
        }

        // SETTLEMENT
        async function runSettlement() {
            let { data: g } = await sb.from('games').select('*').eq('id', r_id).single();
            let givers = g.players.filter(p => p.balance < 0).map(p => ({ name: p.name, amt: Math.abs(p.balance) }));
            let receivers = g.players.filter(p => p.balance > 0).map(p => ({ name: p.name, amt: p.balance }));
            let txs = [];
            givers.sort((a,b) => b.amt-a.amt); receivers.sort((a,b) => b.amt-a.amt);
            let gi=0, ri=0;
            while(gi < givers.length && ri < receivers.length) {
                let pay = Math.min(givers[gi].amt, receivers[ri].amt);
                if(pay > 0) txs.push({ from: givers[gi].name, to: receivers[ri].name, amt: pay.toFixed(2) });
                givers[gi].amt -= pay; receivers[ri].amt -= pay;
                if(givers[gi].amt === 0) gi++; if(receivers[ri].amt === 0) ri++;
            }
            document.getElementById('settlement-list').innerHTML = txs.map(t => `
                <div class="bg-black p-3 rounded border border-gray-800 text-center">
                    <p class="text-[10px] font-bold uppercase"><span class="text-red-500">${t.from}</span> ‚ûú <span class="text-green-500">${t.to}</span></p>
                    <p class="text-lg font-black">$${t.amt}</p>
                    <a href="venmo://paycharge?txn=pay&recipients=${t.to}&amount=${t.amt}&note=PassTheCup" class="block bg-blue-600 text-[9px] py-1 mt-1 rounded font-black">VENMO</a>
                </div>
            `).join('');
            document.getElementById('settlement-area').classList.remove('hidden');
            document.getElementById('end-game-btn').classList.add('hidden');
        }

        function copyScoreboardLink(btn) {
            navigator.clipboard.writeText(scoreboardLink).then(() => {
                btn.innerText = "COPIED!";
                setTimeout(() => btn.innerText = "Copy Scoreboard Link", 2000);
            });
        }
    </script>
</body>
</html>
