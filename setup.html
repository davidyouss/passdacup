<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Setup | Pass The Cup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-black text-white p-6">
    <div class="max-w-md mx-auto space-y-6">
        <h1 class="text-2xl font-black italic text-yellow-500 uppercase">Setup Game</h1>

        <div class="space-y-2">
            <p class="text-xs font-bold text-gray-500 uppercase">1. Add Your Friends</p>
            <div class="flex gap-2">
                <input id="p-input" type="text" placeholder="Name" class="flex-grow bg-gray-900 border border-gray-800 p-3 rounded-lg outline-none">
                <button id="add-btn" class="bg-blue-600 px-6 rounded-lg font-bold">+</button>
            </div>
            <div id="p-list" class="space-y-1 text-sm font-bold"></div>
        </div>

        <div class="space-y-2 pt-4 border-t border-gray-800">
            <p class="text-xs font-bold text-gray-500 uppercase">2. Room Name</p>
            <input id="r-input" type="text" placeholder="ROOM CODE" class="w-full bg-gray-900 border border-gray-800 p-3 rounded-lg uppercase font-black">
            <button id="go-btn" class="w-full bg-yellow-500 text-black font-black py-4 rounded-lg uppercase mt-2">Create Room</button>
        </div>

        <div id="remote" class="hidden pt-6 border-t-2 border-dashed border-gray-800 space-y-4">
            <h2 class="text-center text-yellow-500 font-bold italic uppercase tracking-widest">Manager Remote</h2>
            <div class="grid grid-cols-2 gap-2">
                <button onclick="move('out', this)" class="bg-gray-900 border border-gray-700 p-5 rounded-xl font-bold active:bg-red-600 transition-colors">OUT (+$1)</button>
                <button onclick="move('single', this)" class="bg-gray-900 border border-gray-700 p-5 rounded-xl font-bold active:bg-green-600 transition-colors">1B (-$1)</button>
                <button onclick="move('double', this)" class="bg-gray-900 border border-gray-700 p-5 rounded-xl font-bold active:bg-green-600 transition-colors">2B (-$2)</button>
                <button onclick="move('hr', this)" class="bg-yellow-500 text-black p-5 rounded-xl font-black active:bg-white transition-colors uppercase">Home Run</button>
            </div>
            <p id="share-link" class="text-[10px] text-center text-blue-400 break-all pt-4 font-mono"></p>
        </div>
    </div>

    <script>
        const S_URL = 'https://yhywgwohyzrcbzgxxtyb.supabase.co';
        const S_KEY = 'sb_publishable_zYteMuxmxLbR0mxUDe8a3w_8brmZ2sv';
        const sb = supabase.createClient(S_URL, S_KEY);

        let roster = [];
        let r_id = "";

        document.getElementById('add-btn').onclick = () => {
            const el = document.getElementById('p-input');
            if (el.value.trim()) {
                roster.push({ name: el.value.trim(), balance: 0 });
                el.value = "";
                draw();
            }
        };

        function draw() {
            document.getElementById('p-list').innerHTML = roster.map((p, i) => 
                `<div class="bg-gray-900 p-3 rounded-lg flex justify-between border border-gray-800 uppercase text-[10px]"><span>${i+1}. ${p.name}</span><button onclick="rem(${i})" class="text-red-500 font-black">X</button></div>`
            ).join('');
        }

        function rem(i) { roster.splice(i, 1); draw(); }

        document.getElementById('go-btn').onclick = async () => {
            r_id = document.getElementById('r-input').value.trim().toUpperCase();
            if (!r_id || roster.length === 0) return alert("Add names and a code!");

            const { error } = await sb.from('games').upsert([{ 
                id: r_id, mlb_game_id: 0, players: roster, pot_total: roster.length, current_holder_index: 0 
            }]);

            if (error) {
                alert("Error: " + error.message);
            } else {
                document.getElementById('remote').classList.remove('hidden');
                const link = window.location.origin + "/index.html?id=" + encodeURIComponent(r_id);
                document.getElementById('share-link').innerHTML = "Scoreboard Link:<br><a href='"+link+"' target='_blank' class='underline'>"+link+"</a>";
                alert("Game Created!");
            }
        };

        async function move(type, btn) {
            // Visual feedback that button was pressed
            const originalColor = btn.style.backgroundColor;
            btn.style.opacity = "0.5";

            // 1. Fetch the absolute freshest data
            let { data: g, error } = await sb.from('games').select('*').eq('id', r_id).single();
            if (error || !g) return alert("Database error. Try creating the room again.");

            let pot = parseFloat(g.pot_total);
            let list = g.players;
            let i = parseInt(g.current_holder_index);

            // 2. Perform Math
            if (type === 'out') { 
                pot += 1.0; 
                list[i].balance -= 1.0; 
            } else if (type === 'single') { 
                let pay = Math.min(pot, 1.0); 
                pot -= pay; 
                list[i].balance += pay; 
            } else if (type === 'double') { 
                let pay = Math.min(pot, 2.0); 
                pot -= pay; 
                list[i].balance += pay; 
            } else if (type === 'hr') { 
                list[i].balance += pot; 
                pot = 0.0; 
            }

            // 3. Move to next player
            let next_i = (i + 1) % list.length;

            // 4. Update Database
            const { error: upError } = await sb.from('games').update({
                pot_total: pot, 
                players: list, 
                current_holder_index: next_i
            }).eq('id', r_id);

            if (upError) alert("Update failed: " + upError.message);
            
            btn.style.opacity = "1";
        }
    </script>
</body>
</html>
