<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manager | Pass The Cup</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body class="bg-black text-white p-6 font-sans">
    <div class="max-w-md mx-auto space-y-6">
        <h1 class="text-2xl font-black italic text-yellow-500 uppercase tracking-tighter text-center">Cup Manager Pro</h1>

        <div id="setup-area" class="space-y-4">
            <div class="space-y-2">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">1. Add Lineup</p>
                <div class="flex gap-2">
                    <input id="p-input" type="text" placeholder="Name" class="flex-grow bg-gray-900 border border-gray-800 p-3 rounded-lg outline-none font-bold">
                    <button id="add-btn" class="bg-blue-600 px-6 rounded-lg font-black text-xl">+</button>
                </div>
                <div id="p-list" class="space-y-2 mt-2"></div>
            </div>

            <div class="space-y-2 pt-4 border-t border-gray-800">
                <p class="text-[10px] font-bold text-gray-500 uppercase tracking-widest">2. Select MLB Game</p>
                <button onclick="findGames()" class="w-full bg-gray-800 p-3 rounded-lg text-xs font-bold uppercase border border-gray-700 hover:bg-gray-700">Find Games (Test: July 10 2025)</button>
                <select id="game-select" class="w-full bg-gray-900 border border-gray-800 p-3 rounded-lg text-sm hidden font-bold text-yellow-500"></select>
            </div>

            <button id="go-btn" class="w-full bg-yellow-500 text-black font-black py-4 rounded-xl uppercase shadow-lg shadow-yellow-500/20 mt-4">Start Game</button>
        </div>

        <div id="remote" class="hidden space-y-4 border-t-2 border-dashed border-gray-800 pt-6">
            <div id="live-indicator" class="flex items-center justify-center gap-2 text-[10px] font-bold text-green-500 animate-pulse hidden">
                <span class="w-2 h-2 bg-green-500 rounded-full"></span> MLB AUTO-SYNC ACTIVE
            </div>
            
            <div class="bg-blue-600 p-4 rounded-xl shadow-lg text-center">
                <p class="text-[9px] font-black uppercase text-blue-100 mb-1">Cup is with:</p>
                <h2 id="up-now" class="text-3xl font-black uppercase italic tracking-tighter">---</h2>
            </div>

            <div class="grid grid-cols-2 gap-2">
                <button onclick="move('strikeout', this)" class="bg-gray-900 border-2 border-gray-800 py-4 rounded-xl font-black uppercase text-[10px]">K (+$2)</button>
                <button onclick="move('out', this)" class="bg-gray-900 border-2 border-gray-800 py-4 rounded-xl font-black uppercase text-[10px]">OUT (+$1)</button>
                <button onclick="move('single', this)" class="bg-gray-900 border-2 border-gray-800 py-4 rounded-xl font-black uppercase text-[10px]">1B (-$1)</button>
                <button onclick="move('double', this)" class="bg-gray-900 border-2 border-gray-800 py-4 rounded-xl font-black uppercase text-[10px]">2B (-$2)</button>
                <button onclick="move('triple', this)" class="bg-gray-900 border-2 border-gray-800 py-4 rounded-xl font-black uppercase text-[10px]">3B (-$3)</button>
                <button onclick="move('hr', this)" class="bg-yellow-500 text-black py-4 rounded-xl font-black uppercase text-[10px]">HR (CLEAR)</button>
                <button onclick="move('eject', this)" class="bg-red-600 text-white py-4 rounded-xl font-black uppercase text-[10px] col-span-2">ðŸš¨ PLAYER EJECTED (+$20) ðŸš¨</button>
            </div>
            
            <div class="bg-gray-900 p-3 rounded-xl border border-gray-800 space-y-2">
                <p class="text-[9px] text-gray-500 uppercase font-bold text-center border-b border-gray-800 pb-1">Live Play-by-Play Feed</p>
                <p id="pbp-text" class="text-[11px] italic text-yellow-500 text-center py-1">Waiting for next play...</p>
                <div id="play-history-list" class="space-y-1 pt-2"></div>
            </div>

            <button id="copy-btn" onclick="copyScoreboardLink(this)" class="w-full bg-white text-black font-black py-3 rounded-xl text-xs uppercase">Copy Scoreboard Link</button>
        </div>
    </div>

    <script>
        // *** CONFIGURATION ***
        const S_URL = 'https://yhywgwohyzrcbzgxxtyb.supabase.co';
        const S_KEY = 'sb_publishable_zYteMuxmxLbR0mxUDe8a3w_8brmZ2sv';
        const sb = supabase.createClient(S_URL, S_KEY);

        let roster = [];
        let r_id = "";
        let selectedGamePk = null;
        let lastProcessedPlayIndex = -1;
        let playHistory = [];
        let scoreboardLink = "";

        // *** ROSTER LOGIC ***
        document.getElementById('add-btn').onclick = () => {
            const el = document.getElementById('p-input');
            const name = el.value.trim();
            if (name) {
                roster.push({ name: name, balance: 0 });
                el.value = "";
                drawRoster();
            }
        };

        function drawRoster() {
            const listEl = document.getElementById('p-list');
            listEl.innerHTML = roster.map((p, i) => `
                <div class="bg-gray-900 p-3 rounded-lg flex justify-between items-center border border-gray-800">
                    <span class="text-sm font-bold uppercase tracking-tight">${i + 1}. ${p.name}</span>
                    <button onclick="removePlayer(${i})" class="text-red-500 font-black px-2">X</button>
                </div>
            `).join('');
        }

        function removePlayer(index) {
            roster.splice(index, 1);
            drawRoster();
        }

        // *** MLB API LOGIC ***
        async function findGames() {
            try {
                // TEST DATE: July 10, 2025. Swap back to 'today' when season starts.
                const testDate = "2025-07-10"; 
                const resp = await fetch(`https://statsapi.mlb.com/api/v1/schedule/games/?sportId=1&date=${testDate}`);
                const data = await resp.json();
                const select = document.getElementById('game-select');
                
                if (!data.dates || data.dates.length === 0) {
                    alert("No games found.");
                    return;
                }

                select.innerHTML = '<option value="">-- Choose Game --</option>';
                data.dates[0].games.forEach(g => {
                    const opt = document.createElement('option');
                    opt.value = g.gamePk;
                    opt.text = `${g.teams.away.team.name} @ ${g.teams.home.team.name}`;
                    select.appendChild(opt);
                });
                select.classList.remove('hidden');
            } catch (e) {
                console.error("MLB API Error:", e);
            }
        }

        async function checkMLB() {
            if (!selectedGamePk) return;
            const resp = await fetch(`https://statsapi.mlb.com/api/v1/game/${selectedGamePk}/playByPlay`);
            const data = await resp.json();
            const plays = data.allPlays;
            if (!plays || plays.length === 0) return;

            // THROTTLE: Increment by 1 so we don't blast through a finished game
            const nextPlayIndex = lastProcessedPlayIndex + 1;

            if (nextPlayIndex < plays.length) {
                const play = plays[nextPlayIndex];
                if (play.result && play.result.description) {
                    const desc = play.result.description;
                    document.getElementById('pbp-text').innerText = desc;
                    processPlay(play.result.event.toLowerCase(), desc);
                    lastProcessedPlayIndex = nextPlayIndex;
                }
            }
        }

        function processPlay(event, desc) {
            // Update History UI
            playHistory.unshift(desc);
            if (playHistory.length > 5) playHistory.pop();
            const historyEl = document.getElementById('play-history-list');
            historyEl.innerHTML = playHistory.map(p => 
                `<p class="text-[10px] border-b border-gray-800 py-1 text-gray-400 italic">${p}</p>`
            ).join('');

            // Trigger Cup Logic
            if (event.includes('strikeout')) move('strikeout');
            else if (event.includes('out')) move('out');
            else if (event.includes('single')) move('single');
            else if (event.includes('double')) move('double');
            else if (event.includes('triple')) move('triple');
            else if (event.includes('home_run')) move('hr');
        }

        // *** GAME START & MOVE LOGIC ***
        document.getElementById('go-btn').onclick = async () => {
            if (roster.length < 1) return alert("Add players!");
            
            selectedGamePk = document.getElementById('game-select').value;
            r_id = Math.random().toString(36).substring(2, 6).toUpperCase();
            
            const { error } = await sb.from('games').insert([{ 
                id: r_id, 
                players: roster, 
                pot_total: roster.length, 
                current_holder_index: 0,
                last_event: "Play Ball!" 
            }]);

            if (error) {
                alert("Error: " + error.message);
            } else {
                document.getElementById('setup-area').classList.add('hidden');
                document.getElementById('remote').classList.remove('hidden');
                document.getElementById('up-now').innerText = roster[0].name;
                scoreboardLink = window.location.origin + "/index.html?id=" + r_id;

                if(selectedGamePk) {
                    document.getElementById('live-indicator').classList.remove('hidden');
                    setInterval(checkMLB, 15000); 
                }
            }
        };

        async function move(type, btn) {
            if (btn) btn.style.opacity = "0.5";
            let { data: g } = await sb.from('games').select('*').eq('id', r_id).single();
            
            let pot = parseFloat(g.pot_total);
            let list = g.players;
            let i = parseInt(g.current_holder_index);
            let eventMsg = "";

            if (type === 'strikeout') { pot += 2; list[i].balance -= 2; eventMsg = `${list[i].name} Struck Out! (+$2)`; }
            else if (type === 'out') { pot += 1; list[i].balance -= 1; eventMsg = `${list[i].name} Out (+$1)`; }
            else if (type === 'single') { let pay = Math.min(pot, 1); pot -= pay; list[i].balance += pay; eventMsg = `${list[i].name} hit a Single! (-$1)`; }
            else if (type === 'double') { let pay = Math.min(pot, 2); pot -= pay; list[i].balance += pay; eventMsg = `${list[i].name} hit a Double! (-$2)`; }
            else if (type === 'triple') { let pay = Math.min(pot, 3); pot -= pay; list[i].balance += pay; eventMsg = `${list[i].name} hit a TRIPLE! (-$3)`; }
            else if (type === 'hr') { list[i].balance += pot; eventMsg = `${list[i].name} HOME RUN! POT CLEARED!`; pot = 0; }
            else if (type === 'eject') { pot += 20; list[i].balance -= 20; eventMsg = `ðŸš¨ ${list[i].name} EJECTED! (+$20) ðŸš¨`; }

            let next_i = (i + 1) % list.length;
            document.getElementById('up-now').innerText = list[next_i].name;

            await sb.from('games').update({ 
                pot_total: pot, 
                players: list, 
                current_holder_index: next_i, 
                last_event: eventMsg 
            }).eq('id', r_id);
            
            if (btn) btn.style.opacity = "1";
        }

        function copyScoreboardLink(btn) {
            navigator.clipboard.writeText(scoreboardLink).then(() => {
                const old = btn.innerText;
                btn.innerText = "LINK COPIED!";
                setTimeout(() => btn.innerText = old, 2000);
            });
        }
    </script>
</body>
</html>
